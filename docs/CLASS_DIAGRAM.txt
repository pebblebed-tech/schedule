# Schedule Component - Class Relationship Diagram

## Class Inheritance Hierarchy

```
                                  ESPHome Component
                                         |
                                         |
                                   ┌─────▼─────┐
                                   │  Schedule │ (Base Class)
                                   │           │
                                   │ - Core    │
                                   │ - Virtual │
                                   │ - Methods │
                                   └─────┬─────┘
                                         |
                  ┌──────────────────────┴──────────────────────┐
                  │                                             │
      ┌───────────▼────────────┐                   ┌───────────▼────────────┐
      │ StateBasedSchedulable  │                   │ EventBasedSchedulable  │
      │                        │                   │                        │
      │ - ON/OFF pairs         │                   │ - Event times only     │
      │ - 5 modes              │                   │ - 2 modes              │
      │ - Override:            │                   │ - Override:            │
      │   • setup()            │                   │   • setup()            │
      │   • loop()             │                   │   • loop()             │
      │   • dump_config()      │                   │   • dump_config()      │
      │   • on_schedule_*()    │                   │   • on_schedule_*()    │
      └───────────┬────────────┘                   └───────────┬────────────┘
                  │                                             │
                  │                                             │
      ┌───────────▼────────────┐                   ┌───────────▼────────────┐
      │  Switch Platform       │                   │  Button Platform       │
      │  (switch/)             │                   │  (button/)             │
      │                        │                   │                        │
      │ - Inherits             │                   │ - Inherits             │
      │   StateBasedSchedulable│                   │   EventBasedSchedulable│
      │ - Implements           │                   │ - Implements           │
      │   switch logic         │                   │   button press         │
      └────────────────────────┘                   └────────────────────────┘
```

## Component Composition (Has-A Relationships)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            Schedule (Base)                              │
│                                                                         │
│  ┌────────────────────────────────────────────────────────────┐         │
│  │  Core Data Members                                         │         │
│  │  • schedule_times_[] - uint16_t array (NVS storage)        │         │
│  │  • current_event_index_ - int                              │         │
│  │  • next_event_index_ - int                                 │         │
│  │  • schedule_empty_ - bool                                  │         │
│  │  • ha_schedule_entity_id_ - string                         │         │
│  └────────────────────────────────────────────────────────────┘         │
│                                                                         │
│  ┌────────────────────────────────────────────────────────────┐         │
│  │  Child Components (Pointers)                               │         │
│  │                                                            │         │
│  │  ┌──────────────────────┐                                  │         │
│  │  │  data_sensors_       │ ──┐                              │         │
│  │  │  vector<DataSensor*> │   │                              │         │
│  │  └──────────────────────┘   │                              │         │
│  │                             │                              │         │
│  │  ┌──────────────────────┐   │   ┌─────────────────────┐    │         │
│  │  │ schedule_pref_       │   │   │   DataSensor*       │    │         │
│  │  │ ArrayPreference<>    │   └─▶│                      │   │         │
│  │  └──────────────────────┘       │ - label_            │    │         │
│  │                                 │ - state (float)     │    │         │
│  │  ┌──────────────────────┐       │ - item_type_        │    │         │
│  │  │ update_button_       │       │ - off_behavior_     │    │         │
│  │  │ Button*              │       │ - manual_behavior_  │    │         │
│  │  └──────────────────────┘       └─────────────────────┘    │         │
│  │                                                            │         │
│  │  ┌──────────────────────┐                                  │         │
│  │  │ current_event_sensor_│                                  │         │
│  │  │ Sensor*              │                                  │         │
│  │  └──────────────────────┘                                  │         │
│  │                                                            │         │
│  │  ┌──────────────────────┐                                  │         │
│  │  │ next_event_sensor_   │                                  │         │
│  │  │ Sensor*              │                                  │         │
│  │  └──────────────────────┘                                  │         │
│  └────────────────────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                     StateBasedSchedulable                               │
│                     (extends Schedule)                                  │
│                                                                         │
│  ┌────────────────────────────────────────────────────────────┐         │
│  │  Additional Components                                     │         │
│  │                                                            │         │
│  │  ┌──────────────────────┐                                  │         │
│  │  │ mode_select_         │                                  │         │
│  │  │ ScheduleStateModeSelect*                                │         │
│  │  └──────────┬───────────┘                                  │         │
│  │             │                                              │         │
│  │             │   ┌─────────────────────────────────┐        │         │
│  │             └──▶│ ScheduleStateModeSelect         │        │         │
│  │                 │                                 │        │         │
│  │                 │ Options:                        │        │         │
│  │                 │ - Manual Off                    │        │         │
│  │                 │ - Early Off                     │        │         │
│  │                 │ - Auto                          │        │         │
│  │                 │ - Manual On                     │        │         │
│  │                 │ - Boost On                      │        │         │
│  │                 │                                 │        │         │
│  │                 │ Methods:                        │        │         │
│  │                 │ • set_manual_only_mode(bool)    │        │         │
│  │                 │ • current_option()              │        │         │
│  │                 │ • publish_state()               │        │         │
│  │                 └─────────────────────────────────┘        │         │
│  │                                                            │         │
│  │  ┌──────────────────────┐                                  │         │
│  │  │ indicator_           │                                  │         │
│  │  │ BinarySensor*        │                                  │         │
│  │  └──────────────────────┘                                  │         │
│  └────────────────────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                     EventBasedSchedulable                               │
│                     (extends Schedule)                                  │
│                                                                         │
│  ┌────────────────────────────────────────────────────────────┐         │
│  │  Additional Components                                     │         │
│  │                                                            │         │
│  │  ┌──────────────────────┐                                  │         │
│  │  │ mode_select_         │                                  │         │
│  │  │ ScheduleEventModeSelect*                                │         │
│  │  └──────────┬───────────┘                                  │         │
│  │             │                                              │         │
│  │             │   ┌─────────────────────────────────┐        │         │
│  │             └──▶│ ScheduleEventModeSelect         │        │         │
│  │                 │                                 │        │         │
│  │                 │ Options:                        │        │         │
│  │                 │ - Disabled                      │        │         │
│  │                 │ - Enabled                       │        │         │
│  │                 │                                 │        │         │
│  │                 │ Methods:                        │        │         │
│  │                 │ • set_disabled_only_mode(bool)  │        │         │
│  │                 │ • current_option()              │        │         │
│  │                 │ • publish_state()               │        │         │
│  │                 └─────────────────────────────────┘        │         │
│  └────────────────────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────────────────┘
```

## System Interaction Flow

```
┌─────────────────┐
│  Home Assistant │
│                 │
│  schedule.xyz   │
└────────┬────────┘
         │ API Service Call
         │ schedule.get_schedule
         │
         ▼
┌─────────────────────────────────────┐
│      ESPHome Device                 │
│                                     │
│  ┌──────────────────────────────┐   │
│  │  Schedule Component          │   │
│  │                              │   │
│  │  request_schedule()          │   │
│  │  process_schedule_(json)     │   │
│  │         │                    │   │
│  │         ├──▶ Parse JSON      │   │
│  │         ├──▶ Validate        │   │
│  │         ├──▶ Transform       │   │
│  │         └──▶ Store to NVS    │   │
│  │                              │   │
│  │  loop() - every second       │   │
│  │         │                    │   │
│  │         ├──▶ Check RTC time  │   │
│  │         ├──▶ Find events     │   │
│  │         └──▶ Trigger actions │   │
│  └──────────────────────────────┘   │
│                                     │
│  ┌──────────────────────────────┐   │
│  │  NVS Flash Storage           │   │
│  │                              │   │
│  │  • Schedule times array      │   │
│  │  • Mode preference           │   │
│  │  • Entity ID hash            │   │
│  │  • Data sensor values        │   │
│  └──────────────────────────────┘   │
│                                     │
│  ┌──────────────────────────────┐   │
│  │  RTC Module (I2C)            │   │
│  │                              │   │
│  │  DS1307 / DS3231             │   │
│  │  • Current time              │   │
│  │  • Synced from HA            │   │
│  └──────────────────────────────┘   │
└─────────────────────────────────────┘
```

## Data Flow - Schedule Update

```
User Presses              Schedule Component                  NVS Flash
Update Button             Process Flow                        Storage
     │                          │                                  │
     ▼                          │                                  │
┌─────────┐                     │                                  │
│ Button  │                     │                                  │
│ Press   │──────────────▶ request_schedule()                      │
└─────────┘                     │                                  │
                                ▼                                  │
                    ┌────────────────────────┐                     │
                    │ homeassistant.service  │                     │
                    │ schedule.get_schedule  │                     │
                    └───────────┬────────────┘                     │
                                │                                  │
                                │ JSON Response                    │
                                ▼                                  │
                    ┌────────────────────────┐                     │
                    │ process_schedule_()    │                     │
                    │                        │                     │
                    │ 1. Parse JSON          │                     │
                    │ 2. Validate entries    │                     │
                    │ 3. Convert to minutes  │                     │
                    │ 4. Sort by time        │                     │
                    │ 5. Extract data        │                     │
                    └───────────┬────────────┘                     │
                                │                                  │
                                ├──▶ Update schedule_times_[]      │
                                │                                  │
                                ├──▶ Update data_sensors_[]        │
                                │                                  │
                                ├──▶ Set schedule_empty_          │
                                │                                  │
                                └──▶ save_schedule_to_pref_()─────────▶ Write
                                                                        to NVS
```

## Data Flow - Schedule Execution

```
Every Second Loop         Schedule Logic                      Output
     │                         │                                  │
     ▼                         │                                  │
┌──────────┐                   │                                  │
│ loop()   │                   │                                  │
│ called   │                   │                                  │
└────┬─────┘                   │                                  │
     │                         │                                  │
     ├──▶ Get RTC time         │                                  │
     │                         │                                  │
     ├──▶ Convert to minutes   │                                  │
     │                         │                                  │
     ├──▶ find_current_event() │                                  │
     │    find_next_event()    │                                  │
     │                         │                                  │
     ├──▶ Update sensors       │                                  │
     │    - current_event_     │                                  │
     │      sensor_            │                                  │
     │    - next_event_        │                                  │
     │      sensor_            │                                  │
     │                         │                                  │
     └──▶ Check mode           │                                  │
          │                    │                                  │
          ▼                    │                                  │
     ┌─────────────┐           │                                  │
     │ Mode: Auto? │           │                                  │
     └──────┬──────┘           │                                  │
            │ YES              │                                  │
            ▼                  │                                  │
     ┌──────────────────────┐  │                                  │
     │ StateBasedSchedulable│  │                                  │
     │                      │  │                                  │
     │ Is ON event?         │  │                                  │
     │ ├─YES─▶ publish(ON)  │─┼─────────────────────────────────▶ Switch ON
     │ │                    │  │                                  │
     │ └─NO──▶ publish(OFF) │─┼─────────────────────────────────▶ Switch OFF
     │                      │  │                                  │
     │ Update data sensors  │  │                                  │
     │ from schedule values │  │                                  │
     └──────────────────────┘  │                                  │
                               │                                  │
     ┌──────────────────────┐  │                                  │
     │ EventBasedSchedulable│  │                                  │
     │                      │  │                                  │
     │ Event time match?    │  │                                  │
     │ └─YES─▶ trigger      │ │                                  │
     │         press()      │─ ┼─────────────────────────────────▶ Button Press
     │                      │  │                                  │ (automation)
     │ Update data sensors  │  │                                  │
     │ from schedule values │  │                                  │
     └──────────────────────┘  │                                  │
```

## Memory Layout - NVS Storage

```
State-Based Schedule (Switch):
┌────────────────────────────────────────────────────────────────┐
│ NVS Namespace: "schedule_<id>"                                 │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ Key: "times"                                               │ │
│ │ Type: BLOB                                                 │ │
│ │ Size: (max_entries × 4) + 4 bytes                          │ │
│ │                                                            │ │
│ │ [ON_1][OFF_1][ON_2][OFF_2]...[ON_N][OFF_N][0xFFFF]         │ │
│ │  uint16 uint16 uint16 uint16    uint16 uint16  (term)      │ │
│ └────────────────────────────────────────────────────────────┘ │
│                                                                │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ Key: "mode"                                                │ │
│ │ Type: uint8_t                                              │ │
│ │ Size: 1 byte                                               │ │
│ │ Value: 0-4 (Manual Off, Early Off, Auto, Manual On, Boost) │ │
│ └────────────────────────────────────────────────────────────┘ │
│                                                                │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ Key: "entity_id_hash"                                      │ │
│ │ Type: uint32_t                                             │ │
│ │ Size: 4 bytes                                              │ │
│ │ Value: Hash of ha_schedule_entity_id                       │ │
│ └────────────────────────────────────────────────────────────┘ │
│                                                                │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ Key: "data_<label>"  (per data sensor)                     │ │
│ │ Type: BLOB                                                 │ │
│ │ Size: max_entries × sizeof(item_type)                      │ │
│ │                                                            │ │
│ │ [value_1][value_2]...[value_N]                             │ │
│ │  (uint8, uint16, int32, or float)                          │ │
│ └────────────────────────────────────────────────────────────┘ │
│                                                                │
└────────────────────────────────────────────────────────────────┘


Event-Based Schedule (Button):
┌────────────────────────────────────────────────────────────────┐
│ NVS Namespace: "schedule_<id>"                                 │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ Key: "times"                                               │ │
│ │ Type: BLOB                                                 │ │
│ │ Size: (max_entries × 2) + 4 bytes                          │ │
│ │                                                            │ │
│ │ [EVENT_1][EVENT_2]...[EVENT_N][0xFFFF]                     │ │
│ │  uint16  uint16       uint16   (terminator)                │ │
│ └────────────────────────────────────────────────────────────┘ │
│                                                                │
│ ┌────────────────────────────────────────────────────────────┐ │
│ │ Key: "mode"                                                │ │
│ │ Type: uint8_t                                              │ │
│ │ Size: 1 byte                                               │ │
│ │ Value: 0-1 (Disabled, Enabled)                             │ │
│ └────────────────────────────────────────────────────────────┘ │
│                                                                │
│ (entity_id_hash and data_<label> same as state-based)        │
└────────────────────────────────────────────────────────────────┘
```

## Virtual Method Override Pattern

```
┌──────────────────────────────────────────────────────────────────┐
│  Schedule (Base Class)                                           │
│                                                                  │
│  Virtual Methods:                                                │
│  ┌─────────────────────────────────────────────────────────┐     │
│  │ virtual void setup() { }                                │     │
│  │ virtual void dump_config() { }                          │     │
│  │ virtual void loop() { }                                 │     │
│  │ virtual void on_schedule_changed() { }                  │     │
│  │ virtual void on_schedule_empty_changed(bool) { }        │     │
│  └─────────────────────────────────────────────────────────┘     │
│                                                                  │
│  Common Methods:                                                 │
│  • request_schedule()                                            │
│  • process_schedule_(json)                                       │
│  • find_current_event()                                          │
│  • find_next_event()                                             │
│  • get_data_sensor(label)                                        │
│  • save_schedule_to_pref_()                                      │
│  • load_schedule_from_pref_()                                    │
└──────────────────────────────────────────────────────────────────┘
                         │
         ┌───────────────┴───────────────┐
         ▼                               ▼
┌────────────────────────┐   ┌────────────────────────┐
│ StateBasedSchedulable  │   │ EventBasedSchedulable  │
│                        │   │                        │
│ Override:              │   │ Override:              │
│ • setup()              │   │ • setup()              │
│   - Load mode          │   │   - Load mode          │
│     preference         │   │     preference         │
│   - Setup callbacks    │   │   - Setup callbacks    │
│                        │   │                        │
│ • dump_config()        │   │ • dump_config()        │
│   - Log state-based    │   │   - Log event-based    │
│     info               │   │     info               │
│                        │   │                        │
│ • loop()               │   │ • loop()               │
│   - Check ON/OFF       │   │   - Check event        │
│     state              │   │     triggers           │
│   - Apply mode logic   │   │   - Apply mode logic   │
│   - Publish switch     │   │   - Trigger button     │
│     state              │   │     press              │
│                        │   │                        │
│ • on_schedule_         │   │ • on_schedule_         │
│   changed()            │   │   changed()            │
│   - Update indicators  │   │   - Update event       │
│                        │   │     tracking           │
│                        │   │                        │
│ • on_schedule_empty_   │   │ • on_schedule_empty_   │
│   changed(bool)        │   │   changed(bool)        │
│   - Call mode_select_  │   │   - Call mode_select_  │
│     ->set_manual_      │   │     ->set_disabled_    │
│     only_mode()        │   │     only_mode()        │
└────────────────────────┘   └────────────────────────┘
```

## Legend

```
┌──────┐
│ Box  │  = Class or Component
└──────┘

   │      = Inheritance (is-a)
   ▼

───▶     = Pointer/Reference (has-a)

┌─────┐
│  *  │  = Pointer member variable
└─────┘

// Text = Implementation detail
```
