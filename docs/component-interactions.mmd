sequenceDiagram
    participant HA as Home Assistant
    participant API as ESPHome API
    participant Sched as Schedule
    participant Mode as ModeSelect
    participant Data as DataSensor
    participant Pref as Preferences
    participant Platform as Platform Component
    
    Note over Sched: Setup Phase
    Sched->>Pref: Load schedule from NVS
    Sched->>Pref: Load entity ID hash
    Sched->>Data: Setup data sensors
    Data->>Pref: Load data from NVS
    Sched->>API: Setup HA service call
    
    alt Schedule invalid or entity changed
        Sched->>API: Request schedule
        API->>HA: schedule.get_schedule
        HA-->>API: Schedule JSON
        API-->>Sched: Process schedule
        Sched->>Sched: Parse and validate
        Sched->>Pref: Save to NVS
        Sched->>Data: Update data sensors
        Data->>Pref: Save data to NVS
    end
    
    Note over Sched: Runtime Loop
    loop Every loop()
        Sched->>Sched: Check prerequisites
        Sched->>Sched: Check time validity
        Sched->>Sched: Check HA connection
        Sched->>Sched: Advance events if needed
        
        alt State changed
            Sched->>Data: Update data sensors
            Sched->>Platform: apply_scheduled_state(on)
            Platform->>Platform: Apply platform logic
        end
    end
    
    Note over Mode: User Mode Change
    Mode->>Sched: on_mode_changed("Auto")
    Sched->>Sched: Update state machine
    Sched->>Platform: apply_scheduled_state(on)
